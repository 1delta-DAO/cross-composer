import { useMemo } from "react"
import type { Address } from "viem"
import type { GenericTrade } from "../sdk/types"
import { useTokenPrice } from "./prices/useTokenPrice"
import { zeroAddress } from "viem"
import { CurrencyHandler } from "../sdk/types"

export function usePriceImpact({
  selectedTrade,
  amount,
  quoteOut,
  srcToken,
  dstToken,
  srcChainId,
  dstChainId,
}: {
  selectedTrade?: GenericTrade
  amount: string
  quoteOut?: string
  srcToken?: Address
  dstToken?: Address
  srcChainId?: string
  dstChainId?: string
}): number | undefined {
  const srcTokenPriceAddr = useMemo(() => {
    if (!srcToken || !srcChainId) return undefined
    if (srcToken.toLowerCase() === zeroAddress.toLowerCase()) {
      return CurrencyHandler.wrappedAddressFromAddress(srcChainId, zeroAddress) as Address | undefined
    }
    return srcToken
  }, [srcToken, srcChainId])

  const { price: srcPrice } = useTokenPrice({
    chainId: srcChainId || "",
    tokenAddress: srcTokenPriceAddr,
    enabled: Boolean(srcToken && srcChainId),
  })

  const dstTokenPriceAddr = useMemo(() => {
    if (!dstToken || !dstChainId) return undefined
    if (dstToken.toLowerCase() === zeroAddress.toLowerCase()) {
      return CurrencyHandler.wrappedAddressFromAddress(dstChainId, zeroAddress) as Address | undefined
    }
    return dstToken
  }, [dstToken, dstChainId])

  const { price: dstPrice } = useTokenPrice({
    chainId: dstChainId || "",
    tokenAddress: dstTokenPriceAddr,
    enabled: Boolean(dstToken && dstChainId),
  })

  return useMemo(() => {
    if (!selectedTrade || !amount || !quoteOut || !srcToken || !dstToken || !srcChainId || !dstChainId) {
      return undefined
    }
    try {
      if (!srcPrice || !dstPrice) return undefined

      // Calculate expected output based on spot price
      const inputValue = Number(amount) * srcPrice
      const expectedOutput = inputValue / dstPrice

      // Actual output from trade
      const actualOutput = Number(quoteOut)

      if (expectedOutput <= 0 || actualOutput <= 0) return undefined

      // Price impact = (expected - actual) / expected * 100
      const impact = ((expectedOutput - actualOutput) / expectedOutput) * 100
      return Math.max(0, impact) // Ensure non-negative
    } catch {
      return undefined
    }
  }, [selectedTrade, amount, quoteOut, srcToken, dstToken, srcChainId, dstChainId, srcPrice, dstPrice])
}
